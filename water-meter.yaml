esphome:
  name: water-meter
  friendly_name: Water Meter
  on_boot:
      priority: -10 # Executed after all components have been initialized
      then:
        - lambda: |-
            // Load the stored values into the sensors immediately.
            id(water_meter_total).publish_state(id(total_water_m3));
            id(water_consumption_total).publish_state(id(total_water_m3) * 1000.0);

esp32:
  board: esp32dev
  framework:
    type: esp-idf

  # Fixes the warning in the log
  variant: ESP32
  # If your chip is newer, this enables modern instructions
  # minimum_chip_revision: 3

# Enable Home Assistant API
api:
  encryption:
    key: !secret watermeter_ha_api_key

ota:
  - platform: esphome
    password: !secret watermeter_ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # manual IP added because the ESP is on a different network
  manual_ip:
    # Set this to the IP of the ESP
    static_ip: !secret watermeter_static_ip
    # Set this to the IP address of the router. Often ends with .1
    gateway: !secret watermeter_gateway
    # The subnet of the network. 255.255.255.0 works for most home networks.
    subnet: !secret watermeter_subnet

  power_save_mode: none

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Water Meter AP"
    password: !secret watermeter_ap_password

# Add this section to provide the required time source for the total_daily_energy sensor
time:
  - platform: homeassistant
    id: homeassistant_time

# Enable logging
logger:
  level: INFO

captive_portal:

# Global variable to store the meter reading in m3
# restore_value: yes ensures the value survives a reboot
globals:
  - id: total_water_m3
    type: float
    restore_value: yes
    initial_value: '0.0'
  - id: last_pulse_time
    type: uint32_t
    initial_value: '0'

number:
  - platform: template
    name: "Sync Meter Reading"
    id: sync_meter_reading
    icon: "mdi:water-sync"
    unit_of_measurement: "m³"
    min_value: 0
    max_value: 99999
    step: 0.001
    mode: box
    optimistic: true
    on_value:
      then:
        - lambda: |-
            id(total_water_m3) = x;
            // Update all dependent sensors immediately
            id(water_meter_total).publish_state(x);
            id(water_consumption_total).publish_state(x * 1000.0);

binary_sensor:
  - platform: gpio
    pin:
      number: GPIO21
      mode: INPUT_PULLUP
    id: water_pulse_pin
    internal: true
    filters:
      - delayed_on: 50ms
    on_press:
      then:
        - lambda: |-
            uint32_t now = millis();
            if (id(last_pulse_time) != 0) {
              uint32_t diff = now - id(last_pulse_time);
              // Plausibility check: Ignore pulses faster than 500 ms (120 L/min)
              if (diff > 500) { 
                float instant_flow = 60000.0 / diff;
                id(water_flow).publish_state(instant_flow);
              }
            }
            id(last_pulse_time) = now;

            // Increment meter reading m3
            id(total_water_m3) += 0.001;
            
            // Push values to HA immediately
            id(water_meter_total).publish_state(id(total_water_m3));
            id(water_consumption_total).publish_state(id(total_water_m3) * 1000.0);

sensor:
  - platform: template
    name: "Flow"
    id: water_flow
    unit_of_measurement: "L/min"
    icon: "mdi:water-pump"
    accuracy_decimals: 2
    update_interval: 60s
    # Sets the flow to 0 if no pulse was detected for 60 seconds
    lambda: 'return 0.0;' 

  - platform: template
    name: "Meter Reading"
    id: water_meter_total
    unit_of_measurement: "m³"
    icon: "mdi:gauge"
    device_class: water
    state_class: total_increasing
    accuracy_decimals: 3
    lambda: 'return id(total_water_m3);'
    update_interval: never

  - platform: template
    name: "Consumption Total"
    id: water_consumption_total
    unit_of_measurement: "L"
    device_class: water
    state_class: total_increasing
    accuracy_decimals: 0
    lambda: 'return id(total_water_m3) * 1000.0;'
    update_interval: never

  - platform: total_daily_energy
    name: "Consumption Today"
    power_id: water_flow
    unit_of_measurement: "L"
    icon: "mdi:water-outline"
    accuracy_decimals: 1
    # total_daily_energy needs the time component to reset at midnight
    time_id: homeassistant_time
    filters:
      - multiply: 0.01666666667